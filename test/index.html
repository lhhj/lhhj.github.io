<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Record Video, Gyro & Upload as ZIP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Azure Blob Storage SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@azure/storage-blob@latest/dist/browser/azure-storage-blob.min.js"></script>
  <!-- JSZip Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    video { border: 1px solid #000; width: 320px; height: 240px; }
    button { font-size: 16px; padding: 10px 20px; margin: 5px; }
    #status { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Record Video, Gyro Data & Upload as ZIP</h1>
  
  <!-- Video Preview -->
  <video id="video" autoplay playsinline></video>
  
  <!-- Controls -->
  <div>
    <!-- On iOS you must request gyro permission with a user gesture -->
    <button id="enableGyro">Enable Gyro (iOS)</button>
    <button id="startRecording">Start Recording</button>
    <button id="stopRecording" disabled>Stop Recording</button>
  </div>
  
  <!-- Status Display -->
  <div id="status"></div>
  
  <script>
    // ===========================================
    // Global Variables
    // ===========================================
    let videoStream;
    let mediaRecorder;
    let recordedChunks = [];
    let isRecording = false;
    // Array to hold gyro data rows (CSV rows)
    let gyroData = [];

    // ===========================================
    // UI Utility
    // ===========================================
    function updateStatus(msg) {
      document.getElementById("status").textContent = msg;
      console.log(msg);
    }

    // ===========================================
    // Gyro Data Capture
    // ===========================================
    // Request permission for device orientation on iOS (if needed) and add listener.
    function enableGyro() {
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response === 'granted') {
              window.addEventListener('deviceorientation', recordGyro);
              updateStatus("Gyro enabled (permission granted).");
            } else {
              updateStatus("Gyro permission not granted.");
            }
          })
          .catch(err => {
            console.error("Gyro permission error:", err);
            updateStatus("Gyro permission error: " + err.message);
          });
      } else {
        // For non-iOS or when permission not required.
        window.addEventListener('deviceorientation', recordGyro);
        updateStatus("Gyro enabled (no explicit permission needed).");
      }
    }

    // Event handler that records gyro data when recording is active.
    function recordGyro(event) {
      if (isRecording) {
        const timestamp = new Date().toISOString();
        // Use "N/A" if a value is nullish.
        const alpha = event.alpha !== null ? event.alpha.toFixed(2) : "N/A";
        const beta  = event.beta  !== null ? event.beta.toFixed(2)  : "N/A";
        const gamma = event.gamma !== null ? event.gamma.toFixed(2) : "N/A";
        // Append a CSV-formatted row.
        gyroData.push(`${timestamp},${alpha},${beta},${gamma}`);
      }
    }

    // ===========================================
    // Video Initialization & Recording
    // ===========================================
    async function initVideo() {
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById("video").srcObject = videoStream;
      } catch (err) {
        updateStatus("Error accessing media devices: " + err.message);
      }
    }

    function startRecording() {
      if (!videoStream) {
        updateStatus("No video stream available.");
        return;
      }
      
      // Reset arrays and add CSV header for gyro data.
      recordedChunks = [];
      gyroData = ["timestamp,alpha,beta,gamma"];
      
      // Create the MediaRecorder instance.
      try {
        mediaRecorder = new MediaRecorder(videoStream, { mimeType: 'video/webm' });
      } catch (e) {
        updateStatus("MediaRecorder error: " + e.message);
        return;
      }
      
      mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) {
          recordedChunks.push(e.data);
        }
      };
      
      mediaRecorder.onstart = () => {
        isRecording = true;
        updateStatus("Recording started...");
        document.getElementById("startRecording").disabled = true;
        document.getElementById("stopRecording").disabled = false;
      };
      
      mediaRecorder.onstop = () => {
        isRecording = false;
        updateStatus("Recording stopped. Processing data...");
        createAndUploadZip();
        document.getElementById("startRecording").disabled = false;
        document.getElementById("stopRecording").disabled = true;
      };
      
      mediaRecorder.start();
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
    }

    // ===========================================
    // Create ZIP file and Upload to Azure Blob Storage
    // ===========================================
    async function createAndUploadZip() {
      // Combine recorded video chunks.
      const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
      
      // Use JSZip to create a ZIP archive.
      const zip = new JSZip();
      zip.file("video.webm", videoBlob);
      
      // Create a CSV file with the gyro data.
      const gyroCSV = gyroData.join("\n");
      zip.file("gyro.csv", gyroCSV);
      
      updateStatus("Zipping files...");
      try {
        const zipBlob = await zip.generateAsync({ type: "blob" });
        updateStatus("ZIP file created. Uploading to Azure...");
        uploadZipToAzure(zipBlob);
      } catch (err) {
        console.error("ZIP creation error:", err);
        updateStatus("Error creating ZIP: " + err.message);
      }
    }

    // ===========================================
    // Azure Blob Storage Upload
    // ===========================================
    // Replace these values with your own (for demo only).
    const accountName = "capturedatasor";
    const sasToken = "sp=r&st=2025-02-10T21:40:11Z&se=2025-02-11T05:40:11Z&spr=https&sv=2022-11-02&sr=c&sig=tOMpZTVi%2FDtzMSa811olTJFmaj0WYsCRmWVW1mUu40w%3D"; // Do not embed longâ€‘lived tokens in production.
    const containerName = "stor";
    const blobName = "recording.zip";

    const blobServiceClient = new azblob.BlobServiceClient(
      `https://${accountName}.blob.core.windows.net/?${sasToken}`
    );
    const containerClient = blobServiceClient.getContainerClient(containerName);

    async function ensureContainerExists() {
      try {
        await containerClient.createIfNotExists();
        updateStatus("Container is ready.");
      } catch (err) {
        console.error("Container error:", err);
        updateStatus("Container error: " + err.message);
      }
    }

    async function uploadZipToAzure(zipBlob) {
      try {
        const blockBlobClient = containerClient.getBlockBlobClient(blobName);
        await blockBlobClient.uploadData(zipBlob, {
          blobHTTPHeaders: { blobContentType: "application/zip" }
        });
        updateStatus("Upload successful!");
      } catch (err) {
        console.error("Upload error:", err);
        updateStatus("Upload error: " + err.message);
      }
    }

    // ===========================================
    // Event Listeners
    // ===========================================
    document.getElementById("enableGyro").addEventListener("click", enableGyro);
    document.getElementById("startRecording").addEventListener("click", startRecording);
    document.getElementById("stopRecording").addEventListener("click", stopRecording);

    // Initialize on load.
    window.addEventListener("load", async () => {
      await initVideo();
      await ensureContainerExists();
    });
  </script>
</body>
</html>
